<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src="./js/smallMultiplesTimeChart.js"></script>
    <script type="text/javascript" src="./js/contextTimeChart.js"></script>
    

    <style>
      body{
        font: 12px sans-serif;
        margin: 4px 20px 0px 20px;
        background: whitesmoke;
        /*margin: 0;*/
      }

      #placeholder img {
        border:2px solid #999;
        /*border-radius: 8%;*/
        border-top-right-radius: 8px;
        border-bottom-left-radius: 8px;
        margin:10px 10px;
        box-shadow: 2px 2px 18px rgb(82, 81, 81);
      }

      .zoom {
        cursor: move;
        fill: none;
        pointer-events: all;
      }
    </style>
  </head>
  <body>
    <!-- <center> -->
      <h2>SensorVis Focus+Context: Time Series Visualization Prototype</h2>
      <hr/>
      <h3>Instructions:</h3>
      <p>
        <b>Load A File:</b> Either drag a file from your system file explore and drop it over the 'Choose File' button or click the button and select a file from the dialog. Currently, only a single file can be loaded.</br></br>
        <b>Focus Time Series Chart (top):</b> The top chart is the focus view. You can zoom into this view by double clicking (or double tapping) in the chart. You can also pan the view left or right by clicking and dragging. When you pan or zoom, the bottom context chart will show the time range currently visible in the focus chart as a highlighted gray rectangle.</br></br>
        <b>Context Time Series Chart (bottom):</b> The bottom chart is the context view. In this view, the entire time series is displayed in this chart and the portion of the time series that is currently viewed in the top focus chart is indicated with a gray rectangle. The focus view can be changed by dragging either end of the gray rectangle in the context view or a new rectangle can be made by clicking in a different region of the context chart. You can also click on the rectangle and slide it left or right to change the focus view. This rectangle also changes if the user pans / zooms in the focus view.</br></br>
        <b>Initial Image:</b> It's just a placeholder that goes away when you load data.
      </p>
      <hr/>
      <h3>Controls:</h3>
      <p>
        <label for="fileInput">Files: </label>
        <input type="file" id="fileInput" onchange="loadFile()" multiple><br/><br/>
      </p>
    <!-- </center> -->
    <hr/>
    <h3>Chart:</h3>
    <div id="placeholder">
      <center>
        <!-- <img src="https://picsum.photos/id/870/700/300?grayscale"/> -->
        <img src="https://picsum.photos/id/190/700/300?grayscale"/>
            <!-- <img src= "https://picsum.photos/600/400?grayscale"/> -->
      </center>
    </div>
    <div id="contextChart"></div>
    <div id="smallMultiplesCharts"></div>
    <br/>
    <br/>
    <hr/>
    <center>
      <h4>&copy; <a href="https://www.ornl.gov">Oak Ridge National Laboratory</a>
          <script type="text/javascript">
              document.write(new Date().getFullYear());
          </script>
      </h4>
    </center>

    <script>
      const margin = {top: 30, right: 30, bottom: 20, left: 80};
      let chartData;
      let chart;
      const smallMultipleChartHeight = 200;
      const contextChartHeight = 200;
      let contextChart;
      let smallMultiplesChart;

      let parseTime = d3.timeParse("%H:%M:%S.%f");

      let stripDecimals = function(t) {
        // console.log(t.slice(0, -3));
        // console.log(parseTime(t.slice(0, -3)));
        return t.length > 15 ? t.slice(0, -(t.length - 15)) : t;
      }

      const type = ({time, mr}) =>
        ({date: parseTime(stripDecimals(time)), value: +mr});

      // d3.csv('data/bosch_mr.csv', type)
      //   // ({time, mr}) =>
      //   // ({date: parseTime(time), value: +mr}))
      // .then((data) => {
      //   chartData = data;
      //   console.log(chartData);

      //   let divWidth = document.getElementById('chart').clientWidth;

      //   let chart = overviewDetailTimeChart()
      //     // .margin(margin)
      //     // .width(divWidth)
      //     // .height(chartHeight)
      //     // .showPoints(false)
      //     // .showLine(true)
      //     // .curveFunction(d3.curveStepAfter)
      //     .dateValue(d => d.date)
      //     .yValue(d => d.value);
      //   d3.select('#chart').call(chart, chartData);
      // });

      const loadFile = () => {
        const files = document.getElementById('fileInput').files;
        if (files) {
          let promises = [];
          for (let i = 0; i < files.length; i++) {
            const promise = new Promise(resolve => {
              const reader = new FileReader();
              reader.readAsText(files[i]);
              reader.onload = () => resolve([files[i], reader.result]);
              reader.onerror = (error) => reject(error);
            });
            promises.push(promise);
          }

          let allFileData = [];
          Promise.all(promises)
            .then(fileContents => {
              fileContents.forEach(([file, fileContent]) => {
                try {
                  const fileData = d3.csvParse(fileContent, type);
                  const dateExtent = d3.extent(fileData, d => d.date);
                  console.log(file);
                  allFileData.push({
                    seriesTitle: file.name,
                    dateExtent: dateExtent,
                    values: fileData,
                  });
                } catch (error) {
                  console.log(error);
                }
              });
              console.log(allFileData);
              chartData = allFileData;
              removeChart();
              createChart();
            })
            .catch(error => {
              console.log(error)
            });
          
          // let reader = new FileReader();
          // reader.onload = (file) => {
          //   let data = d3.csvParse(reader.result, type);

          //   // console.log(chartData);
          //   removeChart();
          //   createChart();
          //   // console.log(chartData);
          // }
          // reader.onerror = (error) => console.log(error);
          // reader.readAsText(files[0]);
        }
      }

      const removeChart = () => {
        d3.select('#placeholder').remove();
        d3.select('#contextChart').selectAll("*").remove();
        d3.select('#smallMultiplesCharts').selectAll("*").remove();
      }

      const handleContextRangeBrushing = (brushedDateDomain) => {
        console.log('handling a context brushing');
        console.log(brushedDateDomain);
        if (smallMultiplesChart) {
          smallMultiplesChart.dateDomain(brushedDateDomain);
        }
      };

      const createChart = () => {
        if (chartData) {
          let dateDomain = [
            d3.min(chartData.map(d => d.values), d => d3.min(d, d => d.date)),
            d3.max(chartData.map(d => d.values), d => d3.max(d, d => d.date))
          ];
          const datePadding = (dateDomain[1] - dateDomain[0]) * 0.05;
          dateDomain[0] = new Date(dateDomain[0].getTime() - datePadding);
          dateDomain[1] = new Date(dateDomain[1].getTime() + datePadding);
          console.log(dateDomain);

          let divWidth = document.getElementById('contextChart').clientWidth;

          contextChart = contextTimeChart()
            .margin(margin)
            .width(divWidth)
            .height(contextChartHeight)
            .dateDomain(dateDomain)
            .seriesStartDate(d => d.dateExtent[0])
            .seriesEndDate(d => d.dateExtent[1])
            .seriesName(d => d.seriesTitle)
            .rangeBrushedHandler(handleContextRangeBrushing);
          d3.select('#contextChart').call(contextChart, chartData);

          smallMultiplesChart = smallMultiplesTimeChart()
            .margin(margin)
            .width(divWidth)
            .height(smallMultipleChartHeight)
            .dateDomain(dateDomain)
            .dateValue(d => d.date)
            .yValue(d => d.value)
            .showPoints(false)
            .showLine(true)
            .curveFunction(d3.curveMonotoneX);

          d3.select('#smallMultiplesCharts').call(smallMultiplesChart, chartData);
        }
      };
    </script>
  </body>
</html>